rules_version = '2';

service cloud.firestore {
  function isSignedIn() {
    return request.auth != null;
  }

  function hasRole(role) {
    return request.auth != null && (
      request.auth.token.role == role ||
      (request.auth.token.roles is list && role in request.auth.token.roles) ||
      (request.auth.token.roles is map && request.auth.token.roles[role] == true)
    );
  }

  function hasFlag(flag) {
    return request.auth != null && request.auth.token[flag] == true;
  }

  function isAdmin() {
    return hasFlag('admin') || hasRole('admin');
  }

  function isSales() {
    return hasFlag('sales') || hasRole('sales');
  }

  function isTeamLead() {
    return hasFlag('teamLead') || hasRole('teamLead');
  }

  function isCustomer() {
    return hasFlag('customer') || hasRole('customer');
  }

  function isOwner(uid) {
    return request.auth != null && request.auth.uid == uid;
  }

  match /databases/{db}/documents {
    match /app/config/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /app/meta/{docId} {
      allow read, write: if isAdmin();
    }

    match /catalog/{collectionName}/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /app/state {
      allow read: if isAdmin();
      allow write: if isSignedIn();
    }

    match /app/state/{collectionName}/{docId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }

    match /products/{id} {
      allow read: if true;
      allow create, update, delete: if isAdmin() || isSales();
    }

    match /tariffs/{id} {
      allow read: if true;
      allow create, update, delete: if isAdmin() || isSales();
    }

    match /orders/{orderId} {
      allow create: if isSignedIn();
      allow read: if isOwner(resource.data.userId) || isSales() || isTeamLead() || isAdmin();
      allow update, delete: if isOwner(resource.data.userId) || isAdmin();
    }

    match /users/{uid} {
      allow read: if isOwner(uid) || isSales() || isTeamLead() || isAdmin();
      allow create: if isOwner(uid);
      allow update: if isOwner(uid) || isAdmin();
      allow delete: if isAdmin();
    }

    match /messageThreads/{id} {
      allow read: if isAdmin() ||
        (isSignedIn() && request.auth.uid in resource.data.participants);

      allow create: if isSignedIn() &&
        request.resource.data.participants is list &&
        request.auth.uid in request.resource.data.participants;

      allow update, delete: if isAdmin() ||
        (isSignedIn() && request.auth.uid in resource.data.participants);
    }

    match /messageOffers/{id} {
      allow read: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

    match /leads/{id} {
      allow read: if isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    match /notifications/{id} {
      allow read: if isAdmin() ||
        resource.data.target == 'all' ||
        (isSignedIn() && resource.data.target == request.auth.uid);
      allow create, update, delete: if isAdmin();
    }

    match /rewards/{id} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /customBudgets/{id} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /callRequests/{id} {
      allow read: if isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    match /banner/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /analyticsEvents/{id} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }

    match /disasterRecovery/{doc=**} {
      allow read, write: if isAdmin();
    }

    match /app/{docId} {
      allow read, write: if isAdmin();
    }
  }
}
