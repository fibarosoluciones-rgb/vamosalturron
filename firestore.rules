rules_version = '2';

service cloud.firestore {
  function isSignedIn() {
    return request.auth != null;
  }

  function isAdmin() {
    return isSignedIn() && request.auth.token.admin == true;
  }

  function isOwner(uid) {
    return isSignedIn() && request.auth.uid == uid;
  }

  match /databases/{db}/documents {
    match /tariffs/{id} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    match /messageThreads/{id} {
      allow read: if isAdmin() ||
        (
          isSignedIn() &&
          request.auth.uid in resource.data.participants
        );

      allow create: if isSignedIn() &&
        request.resource.data.participants is list &&
        request.auth.uid in request.resource.data.participants;

      allow update, delete: if isAdmin() ||
        (isSignedIn() && request.auth.uid in resource.data.participants);
    }

    match /messageOffers/{id} {
      allow read: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

    match /leads/{id} {
      allow read: if isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    match /notifications/{id} {
      allow read: if isAdmin() ||
        resource.data.target == 'all' ||
        (isSignedIn() && resource.data.target == request.auth.uid);
      allow create, update, delete: if isAdmin();
    }

    match /users/{uid} {
      allow read: if isOwner(uid) || isAdmin();
      allow create: if isOwner(uid);
      allow update, delete: if isOwner(uid) || isAdmin();
    }

    match /rewards/{id} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /customBudgets/{id} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /callRequests/{id} {
      allow read: if isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    match /banner/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /analyticsEvents/{id} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }

    match /disasterRecovery/{doc=**} {
      allow read, write: if isAdmin();
    }

    match /app/{docId} {
      allow read, write: if isAdmin();
    }
  }
}
